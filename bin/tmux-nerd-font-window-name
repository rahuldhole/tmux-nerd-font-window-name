#!/bin/sh
NAME="$1"
PANES="$2"

# Default icon
ICON=">_"

CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_CONFIG="$CURRENT_DIR/glyphnames.json"
# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Load user icons from JSON file (first priority)
USER_ICONS="$HOME/.config/tmux/custom_icons.json"
if [ -f "$USER_ICONS" ]; then
  if command -v jq >/dev/null 2>&1; then
    USER_ICON=$(jq -r --arg name "$NAME" '.[$name] // empty' "$USER_ICONS" 2>/dev/null)
    if [ -n "$USER_ICON" ] && [ "$USER_ICON" != "null" ]; then
      ICON="$USER_ICON"
    fi
  else
    # Fallback: simple grep-based JSON parsing
    USER_ICON=$(grep -o "\"$NAME\"[[:space:]]*:[[:space:]]*\"[^\"]*\"" "$USER_ICONS" 2>/dev/null | sed -n 's/.*"\([^"]*\)"[[:space:]]*$/\1/p')
    if [ -n "$USER_ICON" ]; then
      ICON="$USER_ICON"
    fi
  fi
fi

# If no user icon, try glyphnames.json (second priority)
if [ "$ICON" = ">_" ] && [ -f "$DEFAULT_CONFIG" ]; then
  if command -v jq >/dev/null 2>&1; then
    # Try exact match first, then fallback patterns ex, seti-, md-, dev-
    GLYPH_ICON=$(jq -r --arg name "$NAME" '
      (.[$name] // 
       .["seti-" + $name] // 
       .["md-" + $name] // 
       .["dev-" + $name] // 
       empty).char' "$DEFAULT_CONFIG" 2>/dev/null)
    if [ -n "$GLYPH_ICON" ] && [ "$GLYPH_ICON" != "null" ]; then
      ICON="$GLYPH_ICON"
    fi
  fi
fi

# Add multi-pane indicator
if [ "$PANES" -gt 1 ]; then
  ICON=" $ICON"
fi

echo "$ICON $NAME"
